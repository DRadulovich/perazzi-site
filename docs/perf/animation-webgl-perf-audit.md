# Animation & WebGL Performance Audit

## PASS 0 — Stack & inventory

- **Framework/runtime** – Next.js 16 + App Router, React 19 on the Vercel stack (Next’s default bundler). Entry point is `src/app/(site)/layout.tsx`, which wires in the `SiteShell` that hosts every marketing page plus global analytics/Speed Insights.
- **Animation libraries** – `framer-motion` (v12) powers visibility-driven reveals, parallax scroll values, and infinite indicators; the bespoke `ChoreoGroup`/`Reveal` system (see `src/styles/site-theme.css:501-560`) builds staggered `clip-path`/`mask` transitions with aggressive `will-change` hints. CSS helpers add `film-grain`, `glint-sweep`, and layered `backdrop-blur`/`mask-image` effects over nearly every hero/cards section. There are no third-party WebGL frameworks—just a custom fluid smoke shader (`src/lib/fluid-smoke.ts:700-804`) driven by pointer events inside the `SectionRevealSmoke` overlay.
- **Key animated routes**:
  - `/` (home): `HeroBanner`, `TimelineScroller`, and `MarqueeFeature` combine `framer-motion`, `SectionBackdrop` parallax, and collapsing reveals with the smoke overlay.
  - `/experience`: `ExperienceHero`, `ExperiencePicker`, `BookingOptions`, `TravelNetwork`, and `MosaicGallery` each layer parallax backgrounds, `ChoreoGroup` reveals, and modal animations.
  - `/shotguns`: `PlatformGrid`, `TriggerExplainer`, `DisciplineRail`, and `EngravingGradesCarousel` rely on reveal shells, horizontal scroll tracking, and collapsible headers with the same smoke/canvas overlay.
  - `/heritage`, `/bespoke`, `/service`, `/concierge` and the `/the-build` Soul Journey page reuse the same primitives (hero parallax, reveal sections, scroll-driven state changes).

## Motion/WebGL inventory table

| Path | Tech | Trigger | Runs continuously? | Notes |
| --- | --- | --- | --- | --- |
| `src/components/home/hero-banner.tsx:96-140` | `framer-motion` + `useScroll` parallax + `ScrollIndicator` | Scroll progress on the hero section plus an infinite “Scroll” pulse | **Yes** – parallax tracks `scrollYProgress` while the section is in view and `ScrollIndicator` (`src/components/home/scroll-indicator.tsx:20-34`) animates forever | Hero media also layers `film-grain` + `backdrop-blur` overlays (`HeroMedia` at lines 204-270) |
| `src/components/home/timeline-scroller.tsx:37-150`, `src/components/ui/section-reveal/section-backdrop.tsx:19-56` | `ChoreoGroup`/`Reveal`, `SectionBackdrop`, `useRevealHeight`, `useParallaxBackground` | Pinning/scrolling the timeline while reveal sections expand/collapse | **Yes** – `useParallaxBackground` attaches `scroll/resize` → rAF loops per backdrop (`src/hooks/use-parallax-background.ts:6-63`) | Timelines also toggle `SectionRevealSmoke` and `RevealCollapsedHeader` (pointer-based WebGL) |
| `src/components/home/marquee-feature.tsx:277-312`, same `SectionBackdrop` | `ChoreoGroup` + collapsed reveal + parallax background | Scroll/pointer interactions inside the champion spotlight reveal | **Yes** when the collapsed teaser is visible and parallax is enabled | Background keeps a pinned image + `SectionBackdrop` parallax; the catcher is that each reveal section registers smoke → pointer event listeners |
| `src/components/experience/ExperienceHero.tsx:20-120` | `framer-motion` parallax + entry fades | Scroll progress over the hero’s card | **While in view** – `useScroll` updates `parallax` and `AnimatePresence` runs on load | Background overlays (`backdrop-blur-xl`, `film-grain`, glint) are also present |
| `src/components/shotguns/PlatformGrid.tsx:682-755` | Horizontal scroll tracker + reveal shell + backdrop | `scroll` events inside the platform carousel | **Yes** – `handleScroll` runs on every scroll tick, recomputing `getClosestCardIndex` (`:173-194`) | Each collapsed header (when the grid is closed) attaches `SectionRevealSmoke`, so the WebGL loop lives beside the scroll listener |
| `src/components/heritage/HeritageEraSection.tsx:39-140` | `useScroll`, `useMotionValueEvent`, `HeritageEventRail` | Scroll-driven progress updates to reveal each era | **Yes** – `scrollYProgress` fires change events that call `setActiveEventIndex` frequently (`:86-117`) and the rail shifts with a `useTransform` value (`HeritageEventRail` at `:25-73`) | The rail keeps `will-change-transform` and clamps parallax even when the user is mid-scroll |
| `src/components/ui/section-reveal/reveal-collapsed-header.tsx:101-155` | WebGL fluid smoke + CSS glint | Pointer-enter/move/leave on collapsed CTA | **Yes while pointer is near the collapsed header** – `SectionRevealSmoke` attaches `pointerenter/move/leave` and starts/stops the simulation (`:53-143`) | Each hero/section (home, shotguns, bespoke, experience, heritage) reuses this component |
| `src/components/ui/section-reveal/section-backdrop.tsx:19-56` | `useParallaxBackground`, large `next/image` backgrounds, overlay gradients | Scroll/resize for every reveal backdrop | **Yes** – `useParallaxBackground` keeps an rAF loop smoothed via `--parallax-y` while the user is near the section | Used in every major reveal section (timeline, marquee, discipline rail, experience picker, visit factory, booking options, travel network, engraving carousel, etc.) |

## PASS 1 — Static hot-path findings

### A. Continuous work on the main thread
1. Every `SectionBackdrop` enables `useParallaxBackground` (`src/hooks/use-parallax-background.ts:6-63`), which binds `scroll`/`resize` listeners and keeps a `requestAnimationFrame` loop alive as long as the section is in view; with ~10 backdrops per page (home, experience, shotguns, heritage, bespoke), multiple rAF callbacks run every scroll tick while each writes to `--parallax-y` on a large background element. **(Risk: High; symptom: jank while scrolling a stack of stacked sections; Confidence: high.)**
2. `SectionRevealSmoke` (`src/components/ui/section-reveal/section-reveal-smoke.tsx:53-143` → `src/lib/fluid-smoke.ts:700-804`) powers a custom WebGL fluid simulation when the user hovers/clicks a collapsed reveal. Each collapsed header adds four pointer listeners and, on movement, starts the GPU-heavy `update` loop that runs dozens of shader passes per frame. The smoke stays active for 5 s after pointerleave and runs at full DPR (clamped to 2). **(Risk: High; symptom: sustained GPU usage/fans when the user rests the pointer on the teaser; Confidence: high.)**
3. Horizontal carousels (`PlatformGrid`) listen to `scroll` and call `getClosestCardIndex` on every tick, so a bounding-box scan of every `[data-index]` card happens per event (`src/components/shotguns/PlatformGrid.tsx:173-194, 682-696`). Even though the handler is passive, it forces layout reads (`getBoundingClientRect`) inside the scroll loop, magnified further by the `setActiveIndex` state updates that rerender card metadata. **(Risk: Medium-High; symptom: scroll-linked jank and repaint churn; Confidence: high.)**
4. The Heritage era layout tracks progress via `useMotionValueEvent(scrollYProgress, "change")` (`src/components/heritage/HeritageEraSection.tsx:86-117`) and calls `setActiveEventIndex` every time the scroll position crosses a threshold, which can fire multiple times per frame during a flick. This also drives `HeritageEventRail`’s `useTransform` animation (`HeritageEventRail` at `:25-73`). **(Risk: Medium; symptom: React renders + layout thrash while scrolling through eras; Confidence: medium.)**

### B. Layout thrash / expensive style recalculation
1. `PlatformGrid`’s `handleScroll` loops through all cards and re-measures each with `getBoundingClientRect` for every scroll event (`:173-194`), then updates React state (`setActiveIndex`) even when the closest card does not change. This rips through layouts and ensures `scroll` never stays smooth. **(Risk: High; symptom: drop in FPS when the carousel is scrolled on desktop; Confidence: high.)**

### C. Paint-heavy / GPU-heavy CSS
1. `ChoreoGroup` taunts every animated card with `clip-path`, masks, and blur while hinting `will-change: transform, opacity, clip-path, filter, mask-position` before the animation even begins (`src/styles/site-theme.css:501-520`). Having dozens of `ChoreoGroup` instances per page (timeline, marquee, experience picker, booking options, platform grid) multiplies the number of layers the browser must rasterize before even reaching the first scroll. **(Risk: Medium; symptom: memory spike + GPU layers building on entry; Confidence: medium.)**
2. `film-grain` (`src/styles/site-theme.css:1080-1105`) animates via a slow steps animation and runs `mix-blend-mode: overlay` across hero/card backdrops, and `glint-sweep` overlays move gradients with `mix-blend-mode` on every hover (`:1110-1130`). Both force GPU blending and paint per frame whenever a hero or card is visible. **(Risk: Medium; symptom: heavy compositing cost and GPU busy-time especially on integrated GPUs; Confidence: medium.)**
3. `backdrop-blur-*` classes show up in every hero (`HeroBanner`, `ExperienceHero`, `ServiceHero`), modals, collapsed CTAs, and `SectionShell` cards. This adds multiple `backdrop-filter` paints per frame because each blur needs to read the backdrop content. `Hero` overlays (`src/components/home/hero-banner.tsx:204-270, 325-370`) and `Dialog` overlays embed repeated `backdrop-blur-sm`/`xl`. **(Risk: Medium; symptom: paint-heavy page loads and reduced FPS on moving background; Confidence: medium.)**

### D. React re-render amplification
1. `HeritageEraSection`’s `useMotionValueEvent` writes `setActiveEventIndex` and triggers callbacks while scrolling (`src/components/heritage/HeritageEraSection.tsx:86-117`), so the entire rail and sidecar text re-render as soon as the progress crosses 0.6/0.4 thresholds. **(Risk: Medium; symptom: React updates in the middle of rapid scrolls; Confidence: medium.)**
2. `PlatformGrid`’s `setActiveIndex` within the scroll handler (`src/components/shotguns/PlatformGrid.tsx:682-696`) wiggles state every time the user scrolls even slightly, which re-renders the card details/CTA toggles while the page composition is still being painted. **(Risk: Medium; Confidence: high.)**

### E. WebGL/canvas-specific red flags
1. The fluid smoke simulation (`src/lib/fluid-smoke.ts:700-804`) executes 8 shader passes (advection, curl, divergence, pressure solve) per frame and never stops while the pointer is active—the pointermove handler (`src/components/ui/section-reveal/section-reveal-smoke.tsx:89-133`) immediately calls `smoke.start()` and schedules a stop only after 5 s of pointerleave. Multiple `RevealCollapsedHeader` instances (home marquee, experience picker, booking options, travel network, shotguns sections, bespoke steps, heritage champions, etc.) instantiate this component, so a single hover can trigger the GPU across the entire viewport. **(Risk: High; symptom: GPU pegged/fans spinning during hover over collapsed CTAs; Confidence: high.)**
2. `SectionBackdrop` uses high-resolution `next/image` fills plus gradient overlays—when `enableParallax` is true (`SectionBackdrop` at `:40-47`), `useParallaxBackground` forces background transforms each scroll, which keeps the GPU busy compositing a large image under `mix-blend-mode` overlays on every paint. **(Risk: Medium; symptom: paint-heavy scroll heavy, especially on battery-limited devices; Confidence: medium.)**

## PASS 2 — Rendering-pipeline mini reports

### 1. Home hero + timeline/marquee stack
- **Continuous work?** Yes—hero parallax (`HeroBanner` `useScroll` at `:96-140`) and the countdown `ScrollIndicator` animation (`src/components/home/scroll-indicator.tsx:20-34`) both keep transforms active while the section is in view, and the timeline/marquee `SectionBackdrop` parallax hooks fire rAF loops for every reveal. **CPU vs GPU:** CPU handles scroll listeners/reveal state transitions; GPU handles `backdrop-blur`, `film-grain`, `glint-sweep`, and repeated `will-change` layers. **Animated props:** `transform`/`translate`, `opacity`, `filter: blur`, `clip-path`, `mask-image`, `backdrop-filter`. **Risk:** High—fans can wake up due to simultaneous parallax + smoke + blur when the hero is pinned, and timeline scroll jitter is likely recorded as long tasks in DevTools. **Ideas:** throttle `useParallaxBackground` updates (e.g., shared scroll handler with `requestAnimationFrame` + `IntersectionObserver` that cancels when the section is offscreen), reduce redundant `will-change` hints after the animation is complete, and swap `glint-sweep`/`film-grain` to simple CSS gradients or static overlays when GPU budgets are tight. **Confidence:** medium-high.

### 2. Shotguns Platform Grid + carousel
- **Continuous work?** Yes—the snapped carousel attaches `scroll` and runs `getClosestCardIndex` for every event (`PlatformGrid` `:173-194`), and the reveal shell hosts `SectionRevealSmoke` (pointer-driven WebGL) plus `SectionBackdrop` parallax (`:710-718`). **CPU vs GPU:** CPU cost comes from bounding-box reads + React state updates each scroll, while GPU paints `backdrop-blur`/`film-grain`/`glint` plus the WebGL smoke when the collapsed header is hovered. **Animated props:** `transform` on horizontal track, `opacity`, `filter`. **Risk:** High—scrolling triggers re-layouts, and hovering the collapsed header may keep the GPU busy long after the pointer leaves. **Ideas:** debounce/batch the `scroll` handler (cache card centers + only recompute when needed), skip the smoke simulation on touch devices or when GPU is busy, and consider just translating the reveal background with CSS (no parallax) while collapsed. **Confidence:** medium.

### 3. Heritage era scroll + event rail
- **Continuous work?** Yes—`useMotionValueEvent` listens to every update of `scrollYProgress` (`:86-117`) and flips `activeEventIndex`, while `HeritageEventRail` (`:25-73`) keeps the track’s `x` value tied to the same motion value. **CPU vs GPU:** CPU handles the scroll listener + state updates, and the GPU repaints the rail with `will-change-transform` and `backdrop-blur` overlays on the slides. **Animated props:** `transform` (rail), `opacity` (hero text), `mask` effects on the timeline pills. **Risk:** Medium—fast scrolls trigger React rerenders, which can cause dropped frames mid-scroll and create the appearance of sticky/pulsing sections. **Ideas:** move the threshold logic into the rail so that `activeEventIndex` only updates when the user crosses discrete markers (use `Math.round` vs incremental thresholds), and consider decoupling `scrollYProgress` from React state by storing the value in a ref and throttling updates. **Confidence:** medium.

### 4. Collapsed reveal headers + smoke overlay
- **Continuous work?** Yes while the pointer lingers—`SectionRevealSmoke` registers `pointerenter/move/leave` and instructs the `createFluidSmoke` simulation to start/stop (`section-reveal-smoke.tsx:89-133` + `fluid-smoke.ts:700-804`). **CPU vs GPU:** CPU handles pointer math + placement inside the event, but the GPU runs eight shader passes per frame (advection, curl, divergence, etc.) even when nothing else is animating. **Animated props:** custom WebGL density fields plus CSS `filter` on the CTA glint. **Risk:** High—hovering the CTA while the collapsed section is on screen can keep the GPU pegged for seconds, especially since the simulation does not pause until 5 s after pointerleave. **Ideas:** replace the WebGL smoke with a CSS gradient or video that stops being rendered when the section is offscreen, reduce updates by limiting pointer tracking (e.g., sample every 4 px), or fall back to a static texture when `prefers-reduced-motion` or battery saver is detected. **Confidence:** high.

